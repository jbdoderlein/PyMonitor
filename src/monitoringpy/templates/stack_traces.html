<!DOCTYPE html>
<html>
<head>
    <title>Stack Traces - PyMonitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vis-timeline@7.7.0/dist/vis-timeline-graph2d.min.css" rel="stylesheet">
    <style>
        .timeline {
            width: 100%;
            height: 200px;
            margin: 20px 0;
        }
        .variable-view {
            max-height: 400px;
            overflow-y: auto;
        }
        .function-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .selected {
            background-color: #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <h1>Stack Traces</h1>
        
        <div class="row">
            <!-- Function List -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Functions with Stack Traces</h5>
                    </div>
                    <div class="card-body function-list" id="functionList">
                        <!-- Functions will be listed here -->
                    </div>
                </div>
            </div>
            
            <!-- Timeline and Variable View -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Stack Trace Timeline</h5>
                    </div>
                    <div class="card-body">
                        <div id="timeline" class="timeline"></div>
                        
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">Local Variables</h6>
                                    </div>
                                    <div class="card-body variable-view" id="localsView">
                                        <!-- Local variables will be shown here -->
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">Global Variables</h6>
                                    </div>
                                    <div class="card-body variable-view" id="globalsView">
                                        <!-- Global variables will be shown here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vis-timeline@7.7.0/dist/vis-timeline-graph2d.min.js"></script>
    <script>
        // Function to format variables for display
        function formatValue(value) {
            if (value === null || value === undefined) return 'None';
            if (typeof value === 'object') {
                return `<strong>${value.type}</strong>: ${value.value}`;
            }
            return value.toString();
        }

        // Function to update variable views
        function updateVariableViews(snapshot) {
            const localsView = document.getElementById('localsView');
            const globalsView = document.getElementById('globalsView');
            
            // Update locals
            localsView.innerHTML = Object.entries(snapshot.locals)
                .map(([name, value]) => `
                    <div class="mb-2">
                        <strong>${name}</strong>: ${formatValue(value)}
                    </div>
                `).join('');
            
            // Update globals
            globalsView.innerHTML = Object.entries(snapshot.globals)
                .map(([name, value]) => `
                    <div class="mb-2">
                        <strong>${name}</strong>: ${formatValue(value)}
                    </div>
                `).join('');
        }

        // Function to create timeline
        function createTimeline(snapshots) {
            const container = document.getElementById('timeline');
            
            // Create items for timeline
            const items = snapshots.map(snapshot => ({
                id: snapshot.id,
                content: `Line ${snapshot.line}`,
                start: new Date(snapshot.timestamp)
            }));
            
            // Create timeline
            const timeline = new vis.Timeline(container, new vis.DataSet(items), {
                height: '200px',
                min: new Date(snapshots[0].timestamp),
                max: new Date(snapshots[snapshots.length - 1].timestamp)
            });
            
            // Handle click events
            timeline.on('select', function(properties) {
                if (properties.items && properties.items.length > 0) {
                    const selectedId = properties.items[0];
                    const selectedSnapshot = snapshots.find(s => s.id === parseInt(selectedId));
                    if (selectedSnapshot) {
                        updateVariableViews(selectedSnapshot);
                    }
                }
            });
            
            // Select first snapshot by default
            timeline.setSelection(snapshots[0].id);
            updateVariableViews(snapshots[0]);
        }

        // Function to load and display function stack trace
        function loadStackTrace(functionId) {
            fetch(`/api/stack-trace/${functionId}`)
                .then(response => response.json())
                .then(trace => {
                    if (trace.error) {
                        console.error(trace.error);
                        return;
                    }
                    createTimeline(trace);
                })
                .catch(error => console.error('Error loading stack trace:', error));
        }

        // Load function list on page load
        fetch('/api/functions-with-traces')
            .then(response => response.json())
            .then(functions => {
                const functionList = document.getElementById('functionList');
                functionList.innerHTML = functions.map(func => `
                    <div class="function-item p-2 border-bottom" onclick="loadStackTrace(${func.id})">
                        <strong>${func.name}</strong><br>
                        <small class="text-muted">
                            ${func.file}:${func.line}<br>
                            ${func.snapshot_count} snapshots
                        </small>
                    </div>
                `).join('');
                
                // Load first function by default if available
                if (functions.length > 0) {
                    loadStackTrace(functions[0].id);
                }
            })
            .catch(error => console.error('Error loading functions:', error));
    </script>
</body>
</html> 