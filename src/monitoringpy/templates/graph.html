<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyMonitor Object Graph</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
    <style>
        body { 
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #navbar {
            padding: 10px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        #cy {
            flex-grow: 1;
            width: 100%;
            background-color: #ffffff;
        }
        .controls {
            position: absolute;
            top: 70px;
            right: 20px;
            z-index: 10;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
        .node-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 10;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            max-width: 300px;
            display: none;
        }
    </style>
</head>
<body>
    <nav id="navbar" class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">PyMonitor</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/">Function Calls</a>
                <a class="nav-link active" href="/graph">Object Graph</a>
            </div>
        </div>
    </nav>

    <div id="cy"></div>

    <div class="controls">
        <button id="fit" class="btn btn-sm btn-outline-secondary mb-2">
            <i class="bi bi-arrows-fullscreen"></i> Fit
        </button>
        <button id="layout" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-diagram-3"></i> Relayout
        </button>
    </div>

    <div class="node-info" id="nodeInfo">
        <h6 class="mb-2">Object Info</h6>
        <div id="nodeDetails"></div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <script>
        // Initialize cytoscape
        var cy = cytoscape({
            container: document.getElementById('cy'),
            elements: [],
            style: [
                {
                    selector: 'node',
                    style: {
                        'label': 'data(label)',
                        'text-wrap': 'wrap',
                        'text-max-width': '100px',
                        'font-size': '10px',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'background-color': '#6FB1FC',
                        'width': 'label',
                        'height': 'label',
                        'padding': '10px'
                    }
                },
                {
                    selector: 'node[nodeType = "function"]',
                    style: {
                        'shape': 'rectangle',
                        'background-color': '#FF7F50',  // Coral color for function nodes
                        'border-width': '2px',
                        'border-color': '#FF4500',  // DarkOrange for border
                        'padding': '15px'
                    }
                },
                {
                    selector: 'node[isPrimitive = true]',
                    style: {
                        'shape': 'round-rectangle',
                        'background-color': '#90EE90',  // LightGreen for primitive values
                        'padding': '5px'
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 2,
                        'line-color': '#ccc',
                        'target-arrow-color': '#ccc',
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier',
                        'label': 'data(label)',
                        'font-size': '8px',
                        'text-rotation': 'autorotate'
                    }
                },
                {
                    selector: 'edge[edgeType = "function_return"]',
                    style: {
                        'line-color': '#FF7F50',  // Coral color for return edges
                        'target-arrow-color': '#FF7F50',
                        'width': 3
                    }
                }
            ],
            layout: {
                name: 'cose',
                padding: 50,
                nodeRepulsion: 8000,
                nodeOverlap: 20,
                idealEdgeLength: 100
            }
        });

        // Load graph data
        async function loadGraph() {
            document.getElementById('loading').style.display = 'block';
            try {
                const response = await fetch('/api/object-graph');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error loading graph:', data.error);
                    return;
                }

                cy.elements().remove();
                cy.add(data.nodes);
                cy.add(data.edges);
                
                // Run layout with animation
                const layout = cy.layout({
                    name: 'cose',
                    animate: true,
                    animationDuration: 1500,
                    componentSpacing: 300,
                    nodeRepulsion: function(node) { 
                        return node.data('nodeType') === 'function' ? 200000 : 100000;
                    },
                    nodeOverlap: 50,
                    idealEdgeLength: function(edge) { 
                        return edge.data('edgeType').startsWith('function') ? 250 : 150;
                    },
                    edgeElasticity: 0.45,
                    nestingFactor: 1.2,
                    gravity: 20,
                    numIter: 3000,
                    initialTemp: 500,
                    coolingFactor: 0.95,
                    minTemp: 1.0,
                    fit: true,
                    padding: 75,
                    spacingFactor: 2
                });
                
                layout.run();
                
                // Fit after layout is complete
                layout.one('layoutstop', () => {
                    cy.fit(75); // Add more padding
                });
            } catch (error) {
                console.error('Error loading graph:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Event handlers
        document.getElementById('fit').addEventListener('click', () => {
            cy.fit(75); // Add more padding when fitting
        });

        document.getElementById('layout').addEventListener('click', () => {
            cy.layout({
                name: 'cose',
                animate: true,
                animationDuration: 1500,
                componentSpacing: 300,
                nodeRepulsion: function(node) { 
                    return node.data('nodeType') === 'function' ? 200000 : 100000;
                },
                nodeOverlap: 50,
                idealEdgeLength: function(edge) { 
                    return edge.data('edgeType').startsWith('function') ? 250 : 150;
                },
                edgeElasticity: 0.45,
                nestingFactor: 1.2,
                gravity: 20,
                numIter: 3000,
                initialTemp: 500,
                coolingFactor: 0.95,
                minTemp: 1.0,
                fit: true,
                padding: 75,
                spacingFactor: 2
            }).run();
        });

        // Node click handler
        cy.on('tap', 'node', function(evt) {
            const node = evt.target;
            const nodeInfo = document.getElementById('nodeInfo');
            const nodeDetails = document.getElementById('nodeDetails');
            
            let details = `
                <p><strong>Type:</strong> ${node.data('type')}</p>
                <p><strong>Value:</strong> ${node.data('label')}</p>
            `;
            
            if (node.data('nodeType') === 'function') {
                details += `
                    <p><strong>File:</strong> ${node.data('file')}</p>
                    <p><strong>Line:</strong> ${node.data('line')}</p>
                    <p><strong>Start Time:</strong> ${new Date(node.data('startTime')).toLocaleString()}</p>
                    <p><strong>End Time:</strong> ${new Date(node.data('endTime')).toLocaleString()}</p>
                `;
            }
            
            details += `<p><strong>ID:</strong> ${node.data('id')}</p>`;
            
            nodeDetails.innerHTML = details;
            nodeInfo.style.display = 'block';
        });

        cy.on('tap', function(evt) {
            if (evt.target === cy) {
                document.getElementById('nodeInfo').style.display = 'none';
            }
        });

        // Initial load
        loadGraph();
    </script>
</body>
</html> 